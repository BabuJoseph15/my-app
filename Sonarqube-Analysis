pipeline {
    agent any
     tools {
       maven 'maven3'
     }
     stages {
	stage('Unit Test') {
            steps {
		tool name: 'maven3', type: 'maven'
                sh 'mvn clean test'
	    }
	 }
	 stage('Sonarqube Analysis') {
            environment {
				scannerHome = tool 'sonar7'
		    }
			steps {
				withSonarQubeEnv('sonar7') {
					sh "${scannerHome}/opt/sonar-scanner"
				  }
				echo "test1"
				sleep time: 30000, unit: 'MILLISECONDS'
				echo "test2"
				script {
						echo "test3"
						def qg = waitForQualityGate()
						echo "test4"
						if (qg.status != 'OK') {
							//error "Pipeline aborted due to quality gate failure: ${qg.status}"
							echo "test4"
					    }
				    }
			    }
	 stage('clean package') {
            steps {
		tool name: 'maven3', type: 'maven'
                sh 'mvn package'
		}
	 }
	 stage('Upload Artifacts to Nexus') {
           steps {
             nexusArtifactUploader artifacts: [
                  [
                     artifactId: 'myweb', 
                     classifier: '', 
                     file: 'target/myweb-1.0-SNAPSHOT.war', 
                     type: 'war'
                   ]
             ], 
             credentialsId: 'Babu-Nexus', 
             groupId: 'in.javahome', 
             nexusUrl: '18.188.178.77:8081', 
             nexusVersion: 'nexus3', 
             protocol: 'http', 
             repository: 'myapp-releases', 
             version: '${revision}'
	    }
         }
      }
      stage('Email Notification'){
          mail bcc: '', body: '''Hi Welcome to jenkins email alerts
          Thanks
          Babu''', cc: '', from: '', replyTo: '', subject: 'Jenkins Job', to: 'babu.joseph@gmail.com'
         }
     }
  }
